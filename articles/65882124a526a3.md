---
title: "ã€Flutter/Riverpod/Mockitoã€‘MVVM + Repositoryã®Unitãƒ†ã‚¹ãƒˆã‚’æ¤œè¨ã™ã‚‹"
emoji: "ğŸ˜"
type: "tech"
topics:
  - "flutter"
  - "test"
published: true
published_at: "2024-06-21 22:17"
---

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

:::details lib
```dart
lib 
ã€€ã€€ã€€ã€€â”œâ”€ modelã€€
  â”‚  â”œ user.dart
  â”‚  â”œ user.freezed.dart
  â”‚  â”” user.g.dart
  â”‚
ã€€ã€€ã€€ã€€â”œâ”€ repository
  â”‚  â”œ api_client.dart
  â”‚  â”” users_repository.dart
  â”‚
ã€€ã€€ã€€ã€€â”œâ”€ controller 
  â”‚  â”œ user_list_page_controller.dart
  â”‚  â”œ user_list_page_controll.freezed.dart
  â”‚  â”œ user_list_page_state.dart
  â”‚  â”” user_list_page_state.freezed.dart
  â”‚
  â”œâ”€ page
  â”‚  â”” user_list_page.dart
```
:::

:::details test
```dart
test 
ã€€ã€€ã€€ã€€â”œâ”€ modelã€€
  â”‚  â”” user_test.dart
  â”‚
ã€€ã€€ã€€ã€€â”œâ”€ repository
  â”‚  â”œ users_repository_test.dart
  â”‚  â”” users_repository_test.mocks.dart
  â”‚
ã€€ã€€ã€€ã€€â”œâ”€ controller 
  â”‚  â”œ user_list_page_controller_test.dart
  â”‚  â”œ user_list_page_controller_test.mocks.dart
  â”‚  â”œ user_list_page_state.dart
  â”‚  â”” user_list_page_state.freezed.dart
  â”‚
  â”œâ”€ page
  â”‚  â”œ mock_user_list_page_controller.dart
  â”‚  â”œ mock_user_list_page_controller.g.dart
  â”‚  â”” user_list_page.dart
```
:::

https://github.com/NoriakiSakata/unit_test_practice



# ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸

:::details Mockito
https://pub.dev/packages/mockito
:::

:::details flutter_riverpod
https://pub.dev/packages/flutter_riverpod
:::

:::details freezed
https://pub.dev/packages/freezed]
:::

:::details dio
https://pub.dev/packages/dio
:::

# ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰

#### Model


:::details å®Ÿè£…ã‚³ãƒ¼ãƒ‰
```dart
@freezed
class User with _$User {
  factory User({required int id, required String name}) = _User;

  factory User.fromJson(Map<String, dynamic> json) => _$UserFromJson(json);
}
```
:::

:::details ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰
```dart
void main() {
  test("user model test", () async {
    final user = User.fromJson(UserMockdata.json);
    expect(user.id, 1);
    expect(user.name, 'Leanne Graham');
  });
}
```
:::


#### Repository

:::details å®Ÿè£…ã‚³ãƒ¼ãƒ‰
```dart
abstract class UsersRepositoryInterface {
  Future<List<User>?> fetchUsers();
}

class UsersRepository implements UsersRepositoryInterface {
  final ApiClient _apiClient;

  UsersRepository({ApiClient? apiClient})
      : _apiClient = apiClient ?? ApiClient();

  @override
  Future<List<User>?> fetchUsers() async {
    final datas = await _apiClient.get('/users');
    if (datas is List<dynamic>) {
      return datas.map((data) => User.fromJson(data)).toList();
    }
    return null;
  }
}
```
:::

:::details ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰
```dart
@GenerateNiceMocks([MockSpec<ApiClient>()])
void main() {
  test(
    'user repository test',
    () async {
      final mockApiClient = MockApiClient();
      final repository = UsersRepository(apiClient: mockApiClient);

      when(mockApiClient.get('/users'))
          .thenAnswer((realInvocation) async => UserMockdata.list);

      expect(
        await repository.fetchUsers(),
        [User(id: 1, name: 'Leanne Graham')],
      );
    },
  );
}
```
:::


#### Controller

:::details å®Ÿè£…ã‚³ãƒ¼ãƒ‰
```dart
@riverpod
class UserListPageController extends _$UserListPageController {
  UserListPageController({UsersRepository? repository})
      : _repository = repository ?? UsersRepository();
  final UsersRepository _repository;

  @override
  Future<UserListPageState> build() async {
    return UserListPageState(users: await fetchUsers());
  }

  Future<List<User>?> fetchUsers() async {
    return await _repository.fetchUsers();
  }
}
```
:::

:::details ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰
```dart
@GenerateNiceMocks([MockSpec<UsersRepository>()])
void main() {
  test(
    'user list page controller test',
    () async {
      final UsersRepository fakeRepository = MockUsersRepository();

      final controller = UserListPageController(repository: fakeRepository);

      final mockData = [
        User(id: 1, name: 'test1'),
        User(id: 2, name: 'test2'),
        User(id: 3, name: 'test3')
      ];

      when(fakeRepository.fetchUsers())
          .thenAnswer((realInvocation) async => mockData);

      expect(
        await controller.fetchUsers(),
        mockData,
      );
    },
  );
}
```
:::
#### Page


:::details å®Ÿè£…ã‚³ãƒ¼ãƒ‰
```dart
class ListPage extends ConsumerWidget {
  const ListPage({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final data = ref.watch(userListPageControllerProvider);
    return Scaffold(
      appBar: AppBar(
        title: const Text('ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§'),
      ),
      body: Center(
        child: data.when(
          data: (state) {
            final users = state.users;
            if (users == null || users.isEmpty) {
              return const Text('ãƒªã‚¹ãƒˆãŒç©ºã§ã™');
            }
            return ListView.builder(
              itemCount: users.length,
              itemBuilder: (context, index) {
                return ListTile(
                  title: Text(users[index].name),
                );
              },
            );
          },
          error: (o, s) => const Text(
            'ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ',
            style: TextStyle(color: Color.fromARGB(255, 165, 142, 140)),
          ),
          loading: () => const CircularProgressIndicator(),
        ),
      ),
    );
  }
}
```
:::

:::details ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰
```dart
void main() {
  final UserListPageController fakeController = MockUserListPageController();

  testWidgets('UserListPage test', (WidgetTester tester) async {
    final container = ProviderContainer(
      overrides: [
        userListPageControllerProvider.overrideWith(() => fakeController)
      ],
    );
    await tester.pumpWidget(
      UncontrolledProviderScope(
        container: container,
        child: const MaterialApp(
          home: ListPage(),
        ),
      ),
    );

    await tester.pumpAndSettle();

    expect(find.text('test'), findsOneWidget);
    expect(find.text('ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§'), findsOneWidget);
  });
}
```

ãƒ¢ãƒƒã‚¯Controllerã‚’åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã§å®šç¾©ã™ã‚‹ã€‚
```dart
part 'mock_user_list_page_controller.g.dart';

@riverpod
class MockUserListPageController extends _$MockUserListPageController
    with Mock
    implements UserListPageController {
  @override
  Future<UserListPageState> build() async {
    return UserListPageState(users: [User(id: 1, name: 'test')]);
  }
}
```
:::

# è§£èª¬
## model
```dart
final user = User.fromJson(UserMockdata.json);
```
ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’fromJsonãƒ¡ã‚½ãƒƒãƒ‰ã«æ¸¡ã™ã€‚

```dart
expect(user.id, 1);
expect(user.name, 'Leanne Graham');
```
jsonã‚’ã‚³ãƒ³ãƒãƒ¼ãƒˆã§ãã‚‹ã‹ç¢ºèªã™ã‚‹ã€‚

## repository
```dart
@GenerateNiceMocks([MockSpec<ApiClient>()])
```
ApiClientã®ãƒ¢ãƒƒã‚¯ã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹ã€‚

```dart
final mockApiClient = MockApiClient();
final repository = UsersRepository(apiClient: mockApiClient);
```
ãƒ¢ãƒƒã‚¯ApiClientã‚’Repositoryã«ã‚»ãƒƒãƒˆã™ã‚‹ã€‚
```dart
when(mockApiClient.get('/users'))
    .thenAnswer((realInvocation) async => UserMockdata.list);
```
ãƒ¢ãƒƒã‚¯ApiClientã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å®šç¾©ã™ã‚‹ã€‚

```dart
expect(
   await repository.fetchUsers(),
   [User(id: 1, name: 'Leanne Graham')],
);
```
fetchUsersã‚’ãƒ†ã‚¹ãƒˆ
ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒä¸€è‡´ã™ã‚‹ã‹ç¢ºèªã™ã‚‹ã€‚

## controller
```dart
@GenerateNiceMocks([MockSpec<UsersRepository>()])
```
Repositoryã®ãƒ¢ãƒƒã‚¯ã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹ã€‚

```dart
final UsersRepository fakeRepository = MockUsersRepository();
final controller = UserListPageController(repository: fakeRepository);
```
ãƒ¢ãƒƒã‚¯Repositoryã‚’Controllerã«ã‚»ãƒƒãƒˆã™ã‚‹ã€‚

```dart
final mockData = [
  User(id: 1, name: 'test1'),
  User(id: 2, name: 'test2'),
  User(id: 3, name: 'test3')
];

when(fakeRepository.fetchUsers())
    .thenAnswer((realInvocation) async => mockData);
```
ãƒ¢ãƒƒã‚¯Repositoryã®fetchUsersã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å®šç¾©ã™ã‚‹ã€‚

```dart
expect(
ã€€ã€€ã€€ã€€await controller.fetchUsers(),
ã€€ã€€ã€€ã€€mockData,
);
```
fetchUsersã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ã€‚
ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒä¸€è‡´ã™ã‚‹ã‹ç¢ºèªã™ã‚‹ã€‚


## page

```dart
part 'mock_user_list_page_controller.g.dart';

@riverpod
class MockUserListPageController extends _$MockUserListPageController
    with Mock
    implements UserListPageController {
  @override
  Future<UserListPageState> build() async {
    return UserListPageState(users: [User(id: 1, name: 'test')]);
  }
}
```
riverpod generatorã§ä½œæˆã—ãŸcontrollerã¯ãƒ¢ãƒƒã‚¯ã®è‡ªå‹•ç”ŸæˆãŒã§ããªã„ã®ã§
åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ¢ãƒƒã‚¯controllerã‚’ä½œæˆã™ã‚‹ã€‚


```dart
final UserListPageController fakeController = MockUserListPageController();
```
ãƒ¢ãƒƒã‚¯Controllerã‚’åˆ-
```dart
final container = ProviderContainer(
  overrides: [
    userListPageControllerProvider.overrideWith(() => fakeController)
  ],
);
```
ProviderContainerã‚’ä½œæˆã™ã‚‹ã€‚
ãƒ¢ãƒƒã‚¯Controllerã§ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã™ã‚‹ã€‚

```dart
await tester.pumpWidget(
      UncontrolledProviderScope(
        container: container,
        child: const MaterialApp(
          home: ListPage(),
        ),
      ),
    );
```dart
UncontrolledProviderScopeã§MaterialAppã‚’ãƒ©ãƒƒãƒ—ã™ã‚‹ã€‚
ProviderContainerã‚’ã‚»ãƒƒãƒˆã™ã‚‹ã€‚


```dart
await tester.pumpAndSettle();
```
éåŒæœŸå‡¦ç†ã®çµæœã‚’å¾…ã¤ã€‚


```dart
expect(find.text('test'), findsOneWidget);
expect(find.text('ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§'), findsOneWidget);
```
ãƒ¦ãƒ¼ã‚¶ãƒ¼åã®`test`ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã€‚
ã‚¿ã‚¤ãƒˆãƒ«ã®`ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§`ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã€‚

